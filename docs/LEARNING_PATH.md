# 学习路径指南

面对一个操作系统内核的代码库，感到无处下手是很正常的。 Chronos OS 的代码虽然经过了模块化处理，但依然有一定的复杂度。

这份指南旨在为你提供一个推荐的阅读和探索顺序。

---

## 第一阶段：宏观视角 (Big Picture)

在深入每一行代码之前，建议先建立对系统的整体认知。

1.  **阅读 [架构设计](ARCHITECTURE_DESIGN.md)**
    *   **重点**: 理解特权级（M-mode / S-mode / U-mode）的分层结构。
    *   **目标**: 弄清楚“谁调用了谁”。比如：用户程序调用内核（Syscall），内核调用硬件接口（SBI）。

2.  **浏览 `kernel/src/main.rs`**
    *   这是内核的入口。
    *   关注 `rust_main` 函数，看它依次初始化了哪些模块（内存、trap、任务等）。这就像看一篇文章的目录。

## 第二阶段：核心机制 (Core Mechanisms)

当你对系统有了大概印象后，可以尝试深入核心模块。建议按以下顺序攻克：

### 1. 内存管理 (`kernel/src/mm/`)
这是操作系统最基础、最复杂的山头。
*   **物理内存**: 查看 `frame_allocator.rs`，了解如何用简单的位图管理物理页。
*   **虚拟内存**: 查看 `page_table.rs`，结合 SV39 文档，理解虚拟地址如何变成物理地址。
*   **进阶**: 查看 `memory_set.rs`，理解内核是如何给每个进程“画”出一个独立的地址空间的。

### 2. Trap 处理 (`kernel/src/trap/`)
这是软硬件交互的枢纽。
*   **入口**: `trap.S` (汇编)。观察它是如何保存通用寄存器的。
*   **分发**: `mod.rs` 中的 `trap_handler`。看它是如何区分“系统调用”、“断点”和“错误”的。

## 第三阶段：运行与交互 (Runtime)

### 1. 任务管理 (`kernel/src/task/`)
*   了解 `TaskControlBlock` (TCB) 里都存了什么。
*   阅读 `switch.S`，这是最神奇的地方——仅仅几行汇编，就实现了两个执行流的切换。

### 2. 用户程序 (`user/`)
*   不要忘了看看用户程序是怎么写的。
*   查看 `user/src/lib.rs`，了解用户态是如何发起系统调用（`ecall`）的。

---

## 建议的调试方法

阅读代码时，光用眼睛看是不够的。建议利用 `make debug` 和 logging：

1.  **添加日志**: 在你看不懂的地方加上 `println!("[DEBUG] var = {:?}", var);`，重新编译运行，观察输出。
2.  **GDB 追踪**: 在关键函数（如 `trap_handler`）打断点，单步执行，观察寄存器的变化。

祝探索愉快。
