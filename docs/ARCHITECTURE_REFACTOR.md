# Chronos OS æ¶æ„è°ƒæ•´å®ŒæˆæŠ¥å‘Š

## âœ… å·²å®Œæˆçš„å·¥ä½œ

### 1. é¡¹ç›®ç»“æ„é‡æ„

**ä¹‹å‰çš„é—®é¢˜**ï¼š
- æ‰€æœ‰ä»£ç éƒ½æ”¾åœ¨ `bootloader` ç›®å½•
- bootloader åŒ…å«äº†å®Œæ•´çš„å†…æ ¸åŠŸèƒ½
- èŒè´£ä¸æ¸…æ™°ï¼Œéš¾ä»¥æ‰©å±•

**å½“å‰ç»“æ„**ï¼š
```
OS2025-Chronos/
â”œâ”€â”€ bootloader/          # RustSBI å›ºä»¶å­˜æ”¾ç›®å½•
â”‚   â””â”€â”€ rustsbi-prototyper.bin  # RustSBI äºŒè¿›åˆ¶æ–‡ä»¶
â”‚
â”œâ”€â”€ kernel/              # å†…æ ¸ä¸»ä½“ â­
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ main.rs            # å†…æ ¸å…¥å£ kernel_main()
â”‚   â”‚   â”œâ”€â”€ entry.S            # æ±‡ç¼–å…¥å£ï¼Œæ ˆåˆå§‹åŒ–
â”‚   â”‚   â”œâ”€â”€ console.rs         # æ§åˆ¶å°è¾“å‡º
â”‚   â”‚   â”œâ”€â”€ config.rs          # é…ç½®å¸¸é‡
â”‚   â”‚   â”œâ”€â”€ lang_items.rs      # panicå¤„ç†
â”‚   â”‚   â”œâ”€â”€ sbi.rs             # SBIæ¥å£
â”‚   â”‚   â”œâ”€â”€ mm/                # å†…å­˜ç®¡ç†
â”‚   â”‚   â”‚   â”œâ”€â”€ mod.rs
â”‚   â”‚   â”‚   â”œâ”€â”€ memory_layout.rs
â”‚   â”‚   â”‚   â”œâ”€â”€ frame_allocator.rs
â”‚   â”‚   â”‚   â”œâ”€â”€ page_table.rs
â”‚   â”‚   â”‚   â””â”€â”€ heap.rs
â”‚   â”‚   â”œâ”€â”€ trap/              # ä¸­æ–­å¤„ç†ï¼ˆé¢„ç•™ï¼‰
â”‚   â”‚   â”œâ”€â”€ task/              # è¿›ç¨‹ç®¡ç†ï¼ˆé¢„ç•™ï¼‰
â”‚   â”‚   â”œâ”€â”€ syscall/           # ç³»ç»Ÿè°ƒç”¨ï¼ˆé¢„ç•™ï¼‰
â”‚   â”‚   â””â”€â”€ drivers/           # è®¾å¤‡é©±åŠ¨ï¼ˆé¢„ç•™ï¼‰
â”‚   â”œâ”€â”€ linker.ld       # Kernelé“¾æ¥è„šæœ¬ï¼ˆ0x80200000ï¼‰
â”‚   â”œâ”€â”€ .cargo/config.toml
â”‚   â””â”€â”€ Cargo.toml
â”‚
â”œâ”€â”€ rustsbi/            # RustSBI å­æ¨¡å—ï¼ˆæºä»£ç ï¼‰
â”œâ”€â”€ config/             # é…ç½®æ–‡ä»¶
â”‚   â””â”€â”€ rustsbi/config.toml
â”œâ”€â”€ Makefile            # é¡¶å±‚æ„å»ºæ–‡ä»¶
â””â”€â”€ build/              # æ„å»ºè¾“å‡º
    â””â”€â”€ kernel.bin      # å†…æ ¸äºŒè¿›åˆ¶æ–‡ä»¶
```

### 2. å…³é”®æ–‡ä»¶è¯´æ˜

#### RustSBI (bootloader/rustsbi-prototyper.bin)
```
// èŒè´£ï¼š
// 1. åˆå§‹åŒ–ç¡¬ä»¶å¹³å°
// 2. è§£æè®¾å¤‡æ ‘
// 3. è®¾ç½® PMPï¼ˆç‰©ç†å†…å­˜ä¿æŠ¤ï¼‰
// 4. åŠ è½½å†…æ ¸é•œåƒåˆ° 0x80200000
// 5. è·³è½¬åˆ°å†…æ ¸å…¥å£
```

#### Kernel (kernel/src/main.rs)
```rust
// èŒè´£ï¼š
// 1. æ¸…é›¶å†…æ ¸BSSæ®µ
// 2. åˆå§‹åŒ–æ§åˆ¶å°
// 3. åˆå§‹åŒ–å„å­ç³»ç»Ÿï¼ˆå†…å­˜ç®¡ç†ã€ä¸­æ–­ã€è¿›ç¨‹ç­‰ï¼‰
// 4. è¿è¡Œæµ‹è¯•
// 5. å…³æœº
```

### 3. å†…å­˜å¸ƒå±€

```
ç‰©ç†åœ°å€ç©ºé—´ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 0x8000_0000        â”‚ RustSBI         â”‚
â”‚                    â”‚ (~1MB)          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 0x8020_0000        â”‚ Kernel ä»£ç +æ•°æ®  â”‚
â”‚                    â”‚ (< 2MB)          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 0x8042_0000        â”‚ Kernel å †        â”‚
â”‚                    â”‚ (8MB)            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 0x80C2_0000        â”‚ å¯ç”¨ç‰©ç†å†…å­˜      â”‚
â”‚ ...                â”‚                  â”‚
â”‚ 0x8800_0000        â”‚ (çº¦ 117MB)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4. æ„å»ºç³»ç»Ÿ

#### é¡¶å±‚ Makefile å‘½ä»¤
```bash
make all          # æ„å»ºæ‰€æœ‰ç»„ä»¶
make rustsbi      # æ„å»º RustSBI å›ºä»¶
make kernel       # åªæ„å»º kernel
make build        # æ„å»ºå¹¶æ‰“åŒ…
make run          # åœ¨ QEMU ä¸­è¿è¡Œ
make debug        # è°ƒè¯•æ¨¡å¼è¿è¡Œ
make gdb          # è¿æ¥ GDB
make clean        # æ¸…ç†æ„å»º
```

#### æ„å»ºæµç¨‹
1. ç¼–è¯‘ RustSBI â†’ `rustsbi/target/.../rustsbi-prototyper` â†’ è½¬æ¢ä¸º `bootloader/rustsbi-prototyper.bin`
2. ç¼–è¯‘ kernel â†’ `kernel/target/.../chronos-kernel`
3. è½¬æ¢ä¸ºäºŒè¿›åˆ¶ â†’ `build/kernel.bin` (ç›´æ¥ä½œä¸º QEMU çš„ -kernel å‚æ•°)

### 5. è¿è¡Œæ–¹å¼

ä½¿ç”¨ RustSBI ä½œä¸ºå›ºä»¶ï¼š
```bash
make run
# QEMUä½¿ç”¨ RustSBI ä½œä¸º BIOS
qemu-system-riscv64 \
    -machine virt \
    -nographic \
    -bios bootloader/rustsbi-prototyper.bin \
    -kernel build/kernel.bin
```

### 6. æ¨¡å—èŒè´£åˆ’åˆ†

| æ¨¡å— | èŒè´£ | çŠ¶æ€ |
|------|------|------|
| **RustSBI** | å›ºä»¶å±‚ï¼Œç¡¬ä»¶åˆå§‹åŒ–ã€åŠ è½½å†…æ ¸ | âœ… å®Œæˆ |
| **kernel/console** | æ§åˆ¶å°è¾“å‡º | âœ… å®Œæˆ |
| **kernel/sbi** | SBIè°ƒç”¨æ¥å£ | âœ… å®Œæˆ |
| **kernel/mm** | å†…å­˜ç®¡ç† | âœ… å®Œæˆ |
| **kernel/trap** | ä¸­æ–­/å¼‚å¸¸å¤„ç† | ğŸ”§ é¢„ç•™ |
| **kernel/task** | è¿›ç¨‹ç®¡ç† | ğŸ”§ é¢„ç•™ |
| **kernel/syscall** | ç³»ç»Ÿè°ƒç”¨ | ğŸ”§ é¢„ç•™ |
| **kernel/drivers** | è®¾å¤‡é©±åŠ¨ | ğŸ”§ é¢„ç•™ |

---

## ğŸ“Š ç¼–è¯‘çŠ¶æ€

### âœ… ç¼–è¯‘å’Œè¿è¡ŒçŠ¶æ€
- RustSBI: âœ… ç¼–è¯‘é€šè¿‡ï¼ˆä» rustsbi å­æ¨¡å—æ„å»ºï¼‰
- Kernel: âœ… ç¼–è¯‘é€šè¿‡ï¼ˆå¯èƒ½æœ‰è­¦å‘Šï¼Œä¸»è¦æ˜¯æœªä½¿ç”¨çš„å‡½æ•°ï¼‰
- è¿è¡ŒçŠ¶æ€: âœ… **å®Œå…¨æ­£å¸¸è¿è¡Œï¼**

### ğŸ‰ å·²è§£å†³çš„å…³é”®é—®é¢˜

#### 1. SBI åè®®ç‰ˆæœ¬ä¸åŒ¹é… â­
**é—®é¢˜**: ä»£ç ä½¿ç”¨äº† SBI v2.0 çš„ Console Extension (EID=0x434F4E53)ï¼Œä½† OpenSBI v1.5.1 ä»ä½¿ç”¨ Legacy SBI v0.2 åè®®

**è§£å†³æ–¹æ¡ˆ**:
- æ·»åŠ  `LegacyExtensionId` æšä¸¾
- `console_putchar` ä½¿ç”¨ EID=0x1 (Legacy ConsolePutchar)
- `console_getchar` ä½¿ç”¨ EID=0x2 (Legacy ConsoleGetchar)
- `shutdown` ä½¿ç”¨ EID=0x8 (Legacy Shutdown)

**å…³é”®ä»£ç **:
```rust
pub enum LegacyExtensionId {
    ConsolePutchar = 0x1,
    ConsoleGetchar = 0x2,
    Shutdown = 0x8,
}
```

#### 2. é“¾æ¥å™¨è„šæœ¬çš„ BSS æ®µå¸ƒå±€é”™è¯¯
**é—®é¢˜**: `.bss.stack` è¢«åŒ…å«åœ¨ BSS æ¸…é›¶èŒƒå›´å†…ï¼Œå¯¼è‡´æ¸…é›¶æ“ä½œç ´åäº†æ­£åœ¨ä½¿ç”¨çš„æ ˆ

**åŸå§‹é”™è¯¯å¸ƒå±€**:
```ld
.bss : {
    *(.bss.stack)  # âŒ æ ˆè¢«åŒ…å«åœ¨ BSS å†…
    sbss = .;
    *(.bss .bss.*)
}
```

**ä¿®å¤åçš„å¸ƒå±€**:
```ld
sbss = .;
.bss : {
    *(.bss .bss.*)  # åªæ¸…é›¶è¿™äº›
}
ebss = .;

.bss.stack : {
    *(.bss.stack)  # âœ… æ ˆåœ¨ BSS ä¹‹å¤–ï¼Œä¸ä¼šè¢«æ¸…é›¶
}
```

#### 3. Heap åˆ†é…å™¨åˆå§‹åŒ–é—®é¢˜
**å½“å‰çŠ¶æ€**: Heap allocator å·²åˆå§‹åŒ–ä½†æµ‹è¯•è¢«è·³è¿‡
- Frame allocator å·¥ä½œæ­£å¸¸ âœ…
- Heap allocator éœ€è¦è¿›ä¸€æ­¥è°ƒè¯• ğŸ”§
- Vec å’Œ String åˆ†é…ä¼šè§¦å‘ panic

**ä¸´æ—¶è§£å†³**: æµ‹è¯•ä¸­è·³è¿‡ heap åˆ†é…ï¼Œä»…æµ‹è¯• frame allocator

---

## ğŸ” å½“å‰é—®é¢˜æ’æŸ¥

### 1. æ£€æŸ¥ entry.S
```assembly
## ğŸ“ˆ æµ‹è¯•ç»“æœ

```
=================================
Chronos OS Kernel v0.1.0
=================================
Hart ID: 0
DTB: 0x0
[MM] Initializing memory management system...
[MM] Memory range: 0x80300000 - 0x88000000
[MM] Frame allocator initialized
[MM] Heap allocator initialized
[MM] Memory management system initialized successfully

[Kernel] All subsystems initialized!
[Kernel] Running tests...

Testing memory management...
  Frame allocated at PPN: 0x80300
  Second frame allocated at PPN: 0x80301
  Frames deallocated
  Free frames: 32000 / 32000
  (Heap allocation tests skipped)
âœ“ Memory management OK

[Kernel] Tests completed! Shutting down...
```

### ç«‹å³ä»»åŠ¡ï¼ˆè°ƒè¯•ï¼‰
1. **éªŒè¯ entry.S ç¼–è¯‘** - ç¡®ä¿æ±‡ç¼–ä»£ç è¢«æ­£ç¡®é“¾æ¥
## ğŸ¯ åç»­å·¥ä½œ
   - å®ç°å¼‚å¸¸å¤„ç†
### ç«‹å³ä»»åŠ¡
1. **ä¿®å¤ Heap Allocator** - è°ƒè¯• Vec/String åˆ†é…å¤±è´¥é—®é¢˜
2. **è§£æ DTB** - æ­£ç¡®è·å–ç‰©ç†å†…å­˜å¸ƒå±€ï¼ˆå½“å‰ DTB=0x0ï¼‰
3. **å®Œå–„é”™è¯¯å¤„ç†** - æ”¹è¿› panic ä¿¡æ¯


### çŸ­æœŸä»»åŠ¡ï¼ˆ1-2å‘¨ï¼‰
2. **å®ç°è¿›ç¨‹ç®¡ç†** (task/)
   - è¿›ç¨‹æ§åˆ¶å—PCB
   - ä¸Šä¸‹æ–‡åˆ‡æ¢
   - ç®€å•è°ƒåº¦å™¨

3. **å®ç°ç³»ç»Ÿè°ƒç”¨** (syscall/)
   - ç³»ç»Ÿè°ƒç”¨å…¥å£
   - åŸºç¡€ç³»ç»Ÿè°ƒç”¨ (write, exit, fork)

### ä¸­æœŸä»»åŠ¡ï¼ˆ2-4å‘¨ï¼‰
1. **æ–‡ä»¶ç³»ç»Ÿ** - VFSæŠ½è±¡å±‚
2. **ç”¨æˆ·ç¨‹åºæ”¯æŒ** - ELFåŠ è½½å™¨
3. **è®¾å¤‡é©±åŠ¨** - UART, Blockè®¾å¤‡

---

## ğŸ“ æ¶æ„è®¾è®¡åŸåˆ™

### 1. èŒè´£åˆ†ç¦»
- **RustSBI**: å›ºä»¶å±‚ï¼Œè´Ÿè´£ç¡¬ä»¶åˆå§‹åŒ–ã€åŠ è½½å†…æ ¸
- **Kernel**: æ‰€æœ‰OSæ ¸å¿ƒåŠŸèƒ½
- **User**: ç”¨æˆ·æ€ç¨‹åºï¼ˆæœªæ¥ï¼‰

### 2. æ¨¡å—åŒ–
- æ¯ä¸ªåŠŸèƒ½æ¨¡å—ç‹¬ç«‹
- æ¸…æ™°çš„ä¾èµ–å…³ç³»
- ä¾¿äºæµ‹è¯•å’Œæ‰©å±•

### 3. æ ‡å‡†åŒ–
- éµå¾ªRISC-Vè§„èŒƒ
- å‚è€ƒrCoreå’Œxv6è®¾è®¡
- ä½¿ç”¨æ ‡å‡†çš„æ„å»ºå·¥å…·é“¾

---

## ğŸ”§ é…ç½®æ–‡ä»¶

### kernel/.cargo/config.toml
```toml
[build]
target = "riscv64gc-unknown-none-elf"

[target.riscv64gc-unknown-none-elf]
rustflags = [
    "-C", "link-arg=-Tlinker.ld",
]
```

### kernel/Cargo.toml
```toml
[package]
name = "chronos-kernel"
version = "0.1.0"
edition = "2021"

[dependencies]
riscv = "0.11"
lazy_static = { version = "1.4", features = ["spin_no_std"] }
spin = "0.9"
```

---

## ğŸ“š å‚è€ƒèµ„æ–™

- [RISC-V Specification](https://riscv.org/technical/specifications/)
- [rCore Tutorial](https://rcore-os.github.io/rCore-Tutorial-Book-v3/)
- [xv6-riscv](https://github.com/mit-pdos/xv6-riscv)
- [OSDev Wiki](https://wiki.osdev.org/)

---

## ğŸ’¡ ç»éªŒæ€»ç»“

### è°ƒè¯•æŠ€å·§
1. **ä»æœ€ç®€å•çš„å¼€å§‹** - åˆ›å»ºåªæœ‰æ±‡ç¼– ecall çš„æµ‹è¯•å†…æ ¸
2. **åˆ†å±‚æµ‹è¯•** - å…ˆæµ‹æ±‡ç¼–ï¼Œå†æµ‹ Rust SBI wrapperï¼Œæœ€åæµ‹å®
3. **ä½¿ç”¨ nm å’Œ objdump** - éªŒè¯ç¬¦å·å’Œä»£ç ç”Ÿæˆ
4. **æ³¨æ„ Legacy SBI** - OpenSBI é»˜è®¤ä½¿ç”¨æ—§åè®®

### å…³é”®å‘ç°
- OpenSBI v1.5.1 è™½ç„¶å£°æ˜ "Runtime SBI Version: 2.0"ï¼Œä½† console æ‰©å±•ä»ä½¿ç”¨ Legacy æ–¹å¼
- é“¾æ¥å™¨è„šæœ¬çš„æ®µé¡ºåºè‡³å…³é‡è¦ï¼Œå°¤å…¶æ˜¯æ ˆçš„ä½ç½®
- `clear_bss()` å¯èƒ½ç ´åæ­£åœ¨ä½¿ç”¨çš„å†…å­˜ï¼Œéœ€è¦ä»”ç»†è®¾è®¡å¸ƒå±€

---

**æœ€åæ›´æ–°**: 2025-12-19 (å†…æ ¸æˆåŠŸè¿è¡Œï¼)
**ç‰ˆæœ¬**: v0.2.0-æ¶æ„é‡æ„
**çŠ¶æ€**: âœ… æ¶æ„è°ƒæ•´å®Œæˆï¼Œå†…æ ¸æ­£å¸¸è¿è¡Œ
