# Chronos OS - 架构设计

> **文档版本**: v0.2.0
> **最后更新**: 2026-01-15

## 概述

Chronos OS 采用分层架构设计，从硬件抽象到用户应用，形成完整的操作系统栈。本文档描述了系统的整体架构和关键设计决策。

---

## 系统架构

### 层次结构

```
┌─────────────────────────────────────────┐
│          用户应用程序 (U-mode)          │
│  ┌─────────────┐  ┌─────────────┐     │
│  │ 00poweroff  │  │ 01hello     │     │
│  └─────────────┘  └─────────────┘     │
└─────────────────────────────────────────┘
                 │ ecall
                 ↓
┌─────────────────────────────────────────┐
│         操作系统内核 (S-mode)           │
│  ┌─────────────┬─────────────┬─────────┐ │
│  │  系统调用   │   任务管理   │ 中断处理 │ │
│  │  (syscall)  │   (task)    │ (trap)  │ │
│  └─────────────┴─────────────┴─────────┘ │
│  ┌─────────────────────────────────────┐ │
│  │           内存管理 (mm)              │ │
│  │  Frame Alloc | Page Table | Heap     │ │
│  └─────────────────────────────────────┘ │
│  ┌─────────────────────────────────────┐ │
│  │          设备驱动 (drivers)          │ │
│  │           UART | Block Device        │ │
│  └─────────────────────────────────────┘ │
└─────────────────────────────────────────┘
                 │ SBI calls
                 ↓
┌─────────────────────────────────────────┐
│      固件层 - RustSBI (M-mode)          │
│  ┌─────────────────────────────────────┐ │
│  │  硬件初始化 | 内存保护 | 引导内核   │ │
│  └─────────────────────────────────────┘ │
└─────────────────────────────────────────┘
                 │
                 ↓
┌─────────────────────────────────────────┐
│            硬件层 (QEMU)               │
│      RISC-V 64 CPU + 内存 + 设备        │
└─────────────────────────────────────────┘
```

---

## 项目结构

### 当前结构

```
OS2025-Chronos/
├── bootloader/          # RustSBI 固件 (M-mode)
├── kernel/              # 操作系统内核 (S-mode)
│   ├── src/
│   │   ├── mm/          # 内存管理
│   │   ├── trap/        # 中断处理
│   │   ├── task/        # 任务管理
│   │   ├── syscall/     # 系统调用
│   │   ├── loader/      # 程序加载
│   │   └── drivers/     # 设备驱动
├── user/                # 用户程序
├── rustsbi/             # RustSBI 源码
└── docs/                # 项目文档
```

### 历史演进

**v0.1.0 (初始架构)**:
- 所有代码在 `bootloader/` 目录
- 混合了固件和内核功能
- 职责不清，难以维护

**v0.2.0 (重构后)**:
- 分离 RustSBI 和内核
- 清晰的模块划分
- 职责分离，便于扩展

---

## 内存布局

### 物理内存布局

```
0x8000_0000  ┌─────────────────────┐
              │ RustSBI (~1MB)      │ ← M-mode 固件
0x8020_0000  ├─────────────────────┤
              │ Kernel (~2MB)       │ ← S-mode 内核
0x8042_0000  ├─────────────────────┤
              │ Kernel Heap (8MB)   │ ← Buddy 分配器
0x80C2_0000  ├─────────────────────┤
              │ Available (~117MB)  │ ← 用户空间
0x8800_0000  └─────────────────────┘
```

### 虚拟内存布局

```
进程虚拟地址空间:
0xFFFF_FFFF_FFFF_FFFF  ┌─────────────────────┐
                       │ Kernel Space        │ ← 内核空间
                       │ (恒等映射)          │
0xFFFF_FFC0_0000_0000  ├─────────────────────┤
                       │                     │
                       │ User Space          │ ← 用户空间
                       │  ├─ User Stack      │
                       │  ├─ User Heap       │
                       │  ├─ User Data       │
                       │  └─ User Code       │
                       │                     │
0x0000_0000_0000_0000  └─────────────────────┘
```

---

## 关键模块设计

### 内存管理 (mm/)

```rust
// 物理内存管理
frame_allocator: FrameAllocator    // 位图分配器

// 虚拟内存管理
page_table: PageTable             // SV39 页表

// 堆分配
heap: BuddyAllocator              // Buddy 系统

// 地址空间
memory_set: MemorySet             // 进程地址空间
```

**设计原则**:
- 分层抽象：硬件 → 物理 → 虚拟 → 应用
- 类型安全：强类型地址表示
- 性能优化：Buddy System O(log n)

### 中断处理 (trap/)

```rust
// 陷入入口/出口 (trap.S)
__alltraps:     // 保存上下文
__restore:      // 恢复上下文

// Trap 处理 (mod.rs)
trap_handler:   // 分发处理

// 上下文管理 (context.rs)
TrapContext:    // 用户态寄存器
```

**特点**:
- 完整的上下文保存/恢复
- 系统调用分发
- 异常处理框架

### 任务管理 (task/)

```rust
// 任务控制块
TaskControlBlock {
    task_status: TaskStatus,
    task_context: TaskContext,
    memory_set: MemorySet,
}

// 上下文切换
__switch(current, next):  // 汇编函数

// 调度器
Scheduler: FIFO 调度策略
```

**支持功能**:
- 任务创建和销毁
- 上下文切换
- 基础调度

---

## 启动流程

### 1. RustSBI 阶段 (M-mode)

```
QEMU 加载 RustSBI
    ↓
RustSBI 初始化硬件
    ↓
解析设备树 (DTB)
    ↓
设置物理内存保护 (PMP)
    ↓
加载内核镜像到 0x80200000
    ↓
跳转到内核入口
```

### 2. 内核初始化 (S-mode)

```
kernel_main(hartid, dtb)
    ↓
清理 BSS 段
    ↓
初始化控制台
    ↓
初始化内存管理
    ↓
初始化 Trap 处理
    ↓
初始化任务管理
    ↓
加载并运行用户程序
```

### 3. 用户程序执行

```
加载 ELF 文件
    ↓
创建用户地址空间
    ↓
设置 TrapContext
    ↓
切换到用户态
    ↓
程序运行 (U-mode)
```

---

## 设计决策

### 1. 架构选择

**RISC-V 64-bit**:
- 简洁的指令集设计
- 强大的特权模式
- 活跃的开源社区

**SV39 页表**:
- 39-bit 虚拟地址空间
- 三级页表平衡性能
- 支持现代操作系统需求

### 2. 语言选择

**Rust (no_std)**:
- 内存安全保证
- 无运行时开销
- 强大的类型系统
- 零成本抽象

### 3. 内存管理策略

**Buddy System**:
- O(log n) 分配复杂度
- 减少内存碎片
- 内核级性能优化

### 4. SBI 接口

**RustSBI**:
- Rust 实现的高性能 SBI
- 更好的类型安全
- 活跃的维护社区

---

## 性能优化

### 内存效率
- Buddy 分配器减少碎片
- 页表懒分配
- FrameTracker 自动回收

### 执行效率
- 汇编优化关键路径
- 内联函数减少调用开销
- 缓存友好的数据结构

### 启动速度
- 最小化初始化代码
- 并行初始化子系统
- 延迟加载非关键组件

---

## 安全特性

### 内存安全
- Rust 编译期保证
- 地址空间隔离
- PMP 硬件保护

### 特权级隔离
- M-mode: RustSBI
- S-mode: 内核
- U-mode: 用户程序

### 系统调用安全
- 参数验证
- 权限检查
- 地址空间检查

---

## 扩展性设计

### 模块化架构
- 清晰的接口定义
- 插件化设备驱动
- 可扩展的系统调用

### 标准化接口
- SBI 标准接口
- RISC-V 规范兼容
- POSIX-like 系统调用

### 硬件抽象
- 设备树支持
- 通用驱动框架
- 多平台兼容性

---

## 测试策略

### 单元测试
- 核心算法验证
- 边界条件测试
- 错误处理测试

### 集成测试
- 模块间交互测试
- 用户程序运行测试
- 系统调用测试

### 性能测试
- 内存分配性能
- 上下文切换开销
- 系统调用延迟

---

## 参考资料

- [RISC-V Privileged Specification](https://riscv.org/technical/specifications/)
- [rCore Tutorial Book](https://rcore-os.github.io/rCore-Tutorial-Book-v3/)
- [The Rust Programming Language](https://doc.rust-lang.org/book/)

---

## 未来规划

### 短期优化
- 完善调度器
- 添加文件系统
- 扩展设备驱动

### 长期目标
- 多核支持
- 网络栈
- 用户态库

---

**文档状态**: 当前架构稳定，支持用户程序运行